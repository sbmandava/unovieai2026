# Nexus Platform - Ockam Security Architecture

> End-to-end encrypted, zero-trust security model for gateway-edge communication using Ockam.

**Version:** 2.0
**Date:** 2026-02-06
**Status:** Phase 2 Complete (Authority + Credential Flow)

---

## Executive Summary

This document describes how the Nexus platform can leverage **Ockam** to establish cryptographically secure, end-to-end encrypted communication between edge proxies (at customer sites) and gateways (in the datacenter). This architecture provides defense-in-depth that goes beyond traditional TLS, ensuring data remains protected even if intermediate systems are compromised.

### Key Benefits

| Benefit | Description |
|---------|-------------|
| **End-to-End Encryption** | Data encrypted at edge, decrypted at destination - not at gateway |
| **Zero-Trust Model** | No implicit trust in network boundaries or intermediaries |
| **Mutual Authentication** | Both edge and gateway cryptographically verify each other |
| **Credential-Based Authorization** | Fine-grained access control based on identity attributes |
| **No Exposed Ports** | Edge initiates outbound connections only - works through NAT/firewalls |
| **Customer Isolation** | Cryptographic separation between customers |

---

## 1. Problem Statement

### Current Architecture Limitations

The current TLS + certificate pinning approach has limitations:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  CURRENT MODEL: TLS Point-to-Point                                          │
│                                                                             │
│  Edge ──────── TLS ──────── Gateway ──────── Plain ──────── Backend        │
│                                    ▲                                        │
│                                    │                                        │
│                         Gateway sees plaintext                              │
│                         Gateway compromise = data leak                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Problems:**
1. TLS terminates at gateway - data is plaintext inside datacenter
2. Gateway compromise exposes all customer data
3. No cryptographic customer isolation
4. Trust placed in network boundaries, not cryptography
5. Certificate pinning only verifies transport, not application-level trust

### Ockam Solution

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  OCKAM MODEL: End-to-End Encryption                                         │
│                                                                             │
│  Edge ═══════ Secure Channel ═══════ Gateway ═══════ Secure Channel ═══════ │
│        (Noise XX + AES-256-GCM)              (Noise XX + AES-256-GCM)       │
│                                                                             │
│  - Data encrypted at source, decrypted at destination                       │
│  - Gateway only routes encrypted messages                                   │
│  - Mutual authentication via identity verification                          │
│  - Credential-based authorization on every message                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Ockam Core Concepts

### 2.1 Secure Channels

A **Secure Channel** is an end-to-end encrypted, mutually authenticated communication pathway:

- **Handshake**: Noise Protocol XX (X25519 ECDH + AES-256-GCM)
- **Encryption**: AES-256-GCM with per-message nonce
- **Authentication**: Mutual identity verification during handshake
- **Replay Protection**: Nonce sequence tracking with 8-message window
- **Forward Secrecy**: Ephemeral keys destroyed after handshake

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SECURE CHANNEL ESTABLISHMENT                              │
│                                                                             │
│  Edge Identity                                          Gateway Identity    │
│       │                                                        │            │
│       │ ─── Message 1: ephemeral_key + identity ──────────────►│            │
│       │                                                        │            │
│       │ ◄── Message 2: ephemeral_key + encrypted(identity) ────│            │
│       │                                                        │            │
│       │ ─── Message 3: encrypted(credential) ─────────────────►│            │
│       │                                                        │            │
│       │                 ═══ CHANNEL ESTABLISHED ═══            │            │
│       │                                                        │            │
│       │ ════ All subsequent messages encrypted (AES-256-GCM) ══│            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Identities

An **Identity** is a cryptographic representation of an entity:

- **Identifier**: SHA-256 hash of identity state (unique, tamper-proof)
- **Key Pairs**: X25519 (key exchange) + Ed25519 (signatures)
- **Change Log**: Verified chain of key rotations
- **Verification**: Cryptographic proof of key possession

### 2.3 Credentials

**Credentials** are signed attestations of identity attributes:

```
Credential {
    subject: Identifier,          // Who this credential is about
    issuer: Identifier,           // Who issued it (authority)
    attributes: {
        "customer_id": "cust_001",
        "role": "edge",
        "tier": "professional",
        "capabilities": ["search", "ingest", "query"]
    },
    expires_at: Timestamp,
    signature: Ed25519Signature   // Issuer's signature
}
```

### 2.4 Portals (Inlets/Outlets)

**Portals** bridge raw TCP traffic with Ockam's secure routing:

- **Inlet**: Listens locally, wraps TCP in Ockam messages, routes to outlet
- **Outlet**: Receives Ockam messages, unwraps to raw TCP, forwards to destination
- **Secure Portal**: Inlet → Secure Channel → Outlet

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SECURE PORTAL                                      │
│                                                                             │
│  Customer App          Edge                 Gateway               Backend   │
│       │                  │                     │                     │      │
│       ├──(raw TCP)──────►│ Inlet              │                     │      │
│       │                  │   │                │                     │      │
│       │                  │   ├─(encrypt)─────►│ Outlet              │      │
│       │                  │   │  AES-256-GCM   │   │                 │      │
│       │                  │   │                │   ├──(raw TCP)─────►│      │
│       │                  │   │                │   │                 │      │
│       │                  │   │◄─(encrypt)─────│   │◄──(response)────│      │
│       │◄──(response)─────│   │                │   │                 │      │
│       │                  │   │                │   │                 │      │
│                                                                             │
│  Key: TCP traffic is encrypted end-to-end (Edge ↔ Backend)                 │
│       Gateway only sees encrypted bytes                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Architecture Design

### 3.1 Component Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              OCKAM SECURITY ARCHITECTURE                                 │
│                                                                                         │
│  CUSTOMER SITE                           NEXUS DATACENTER                               │
│  ─────────────                           ────────────────                               │
│                                                                                         │
│  ┌───────────────────────┐               ┌─────────────────────────────────────────┐   │
│  │    nexus-edge         │               │           CREDENTIAL AUTHORITY          │   │
│  │                       │               │                                         │   │
│  │  ┌─────────────────┐  │               │  ├─ Issues credentials to edges         │   │
│  │  │ Ockam Node      │  │               │  ├─ Issues credentials to gateways      │   │
│  │  │                 │  │               │  ├─ Maintains identity registry         │   │
│  │  │ ├─ Identity     │  │               │  └─ Handles credential revocation       │   │
│  │  │ ├─ Credential   │  │               │                                         │   │
│  │  │ └─ Inlet        │  │               └─────────────────────────────────────────┘   │
│  │  └────────┬────────┘  │                              │                              │
│  │           │           │                              │ (credential issuance)        │
│  └───────────┼───────────┘                              │                              │
│              │                                          │                              │
│              │ Outbound TCP                             ▼                              │
│              │ (Secure Channel)         ┌─────────────────────────────────────────┐   │
│              │                          │            OCKAM RELAY                   │   │
│              │                          │                                         │   │
│              └─────────────────────────►│  ├─ Public TCP endpoint                 │   │
│                                         │  ├─ Routes encrypted messages           │   │
│                                         │  ├─ No access to plaintext              │   │
│                                         │  └─ Handles NAT traversal               │   │
│                                         │                                         │   │
│                                         └──────────────────┬──────────────────────┘   │
│                                                            │                          │
│                                                            │ (encrypted routing)      │
│                                                            ▼                          │
│                                         ┌─────────────────────────────────────────┐   │
│                                         │         nexus-gateway (per customer)    │   │
│                                         │                                         │   │
│                                         │  ┌─────────────────────────────────┐   │   │
│                                         │  │ Ockam Node                      │   │   │
│                                         │  │                                 │   │   │
│                                         │  │ ├─ Identity                     │   │   │
│                                         │  │ ├─ Secure Channel Listener      │   │   │
│                                         │  │ ├─ Credential Verifier          │   │   │
│                                         │  │ ├─ Access Control               │   │   │
│                                         │  │ └─ Outlets (per service)        │   │   │
│                                         │  │     ├─ outlet_orchestrator      │   │   │
│                                         │  │     ├─ outlet_inference         │   │   │
│                                         │  │     └─ outlet_context           │   │   │
│                                         │  └─────────────────────────────────┘   │   │
│                                         │                                         │   │
│                                         └──────────────────┬──────────────────────┘   │
│                                                            │                          │
│                                                            │ (authenticated requests) │
│                                                            ▼                          │
│                                         ┌─────────────────────────────────────────┐   │
│                                         │           BACKEND SERVICES              │   │
│                                         │                                         │   │
│                                         │  nexus-orchestrator (8000)              │   │
│                                         │  nexus-inference (8801)                 │   │
│                                         │  nexus-context (8151)                   │   │
│                                         │                                         │   │
│                                         └─────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Component Responsibilities

#### Credential Authority

| Responsibility | Description |
|---------------|-------------|
| Identity Registry | Maintains list of valid edge and gateway identities |
| Credential Issuance | Signs credentials with attributes (customer_id, role, tier) |
| Credential Revocation | Invalidates credentials for decommissioned edges |
| Trust Anchor | Root of trust for the entire system |

#### Ockam Relay

| Responsibility | Description |
|---------------|-------------|
| Public Endpoint | Provides TCP endpoint reachable from edge devices |
| Message Routing | Forwards encrypted messages between edges and gateways |
| NAT Traversal | Enables edges behind firewalls to connect |
| No Plaintext Access | Cannot decrypt messages (no keys) |

#### nexus-edge (Enhanced)

| Responsibility | Description |
|---------------|-------------|
| Ockam Identity | Creates and stores local identity |
| Credential Management | Requests and refreshes credentials from authority |
| Secure Channel | Establishes encrypted channel to gateway via relay |
| TCP Inlet | Wraps local HTTP requests into secure messages |
| License Injection | Adds license header to requests |

#### nexus-gateway (Enhanced)

| Responsibility | Description |
|---------------|-------------|
| Ockam Identity | Creates and stores gateway identity |
| Secure Channel Listener | Accepts incoming secure channels from edges |
| Credential Verification | Validates edge credentials on connection |
| Access Control | Enforces per-message authorization |
| TCP Outlets | Forwards authenticated requests to backend services |

---

## 4. Security Properties

### 4.1 Threat Model

| Threat | Protection |
|--------|------------|
| **Network Interception** | AES-256-GCM encryption on all messages |
| **Replay Attacks** | Nonce sequence tracking, message rejection |
| **Man-in-the-Middle** | Mutual authentication via Noise Protocol XX |
| **Identity Spoofing** | Cryptographic identity verification |
| **Unauthorized Access** | Credential-based access control |
| **Gateway Compromise** | Gateway cannot decrypt end-to-end messages |
| **Relay Compromise** | Relay only sees encrypted traffic |
| **Credential Theft** | Time-limited credentials, revocation support |
| **Cross-Customer Access** | Customer isolation via credential attributes |

### 4.2 Trust Boundaries

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TRUST BOUNDARIES                                   │
│                                                                             │
│  ┌─────────────────┐                     ┌─────────────────┐                │
│  │  CUSTOMER SITE  │                     │   DATACENTER    │                │
│  │                 │                     │                 │                │
│  │  Edge Identity  │ ═══════════════════ │ Gateway Identity│                │
│  │  (trusted)      │   Secure Channel    │ (trusted)       │                │
│  │                 │   (verified both    │                 │                │
│  │                 │    directions)      │                 │                │
│  └─────────────────┘                     └─────────────────┘                │
│                                                                             │
│  Trust Establishment:                                                        │
│  1. Edge presents credential signed by authority                            │
│  2. Gateway verifies credential signature + attributes                       │
│  3. Gateway presents its own credential                                      │
│  4. Edge verifies gateway identity                                          │
│  5. Secure channel established with session keys                            │
│  6. All subsequent messages encrypted + authenticated                        │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════════│
│                                                                             │
│  Messages are ONLY decrypted at:                                            │
│  - Edge (for responses)                                                     │
│  - Destination service (for requests)                                       │
│                                                                             │
│  Messages are NEVER decrypted at:                                           │
│  - Relay (no keys)                                                          │
│  - Gateway routing layer (optional - can be pass-through)                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Cryptographic Guarantees

| Property | Mechanism | Strength |
|----------|-----------|----------|
| **Confidentiality** | AES-256-GCM | 256-bit symmetric |
| **Integrity** | GCM authentication tag | 128-bit tag |
| **Authenticity** | Noise Protocol XX | X25519 + Ed25519 |
| **Forward Secrecy** | Ephemeral DH keys | Per-session keys |
| **Replay Protection** | Nonce sequence | 64-bit counter |

---

## 5. Implementation Design

### 5.1 Credential Schema

```rust
// Edge credential attributes
struct EdgeCredential {
    customer_id: String,      // "cust_001"
    license_key: String,      // "nx_lic_professional_xxxxx"
    tier: String,             // "professional"
    role: String,             // "edge"
    capabilities: Vec<String>, // ["search", "ingest", "query", "mcp"]
    rate_limit_rpm: u32,      // 2000
}

// Gateway credential attributes
struct GatewayCredential {
    gateway_id: String,       // "gateway-customer-a"
    customer_id: String,      // "cust_001"
    role: String,             // "gateway"
    backend_access: Vec<String>, // ["orchestrator", "inference", "context"]
}
```

### 5.2 Edge Implementation

```rust
// nexus-edge with Ockam integration
use ockam::{node, route, Context, TcpInletOptions, TcpTransportExtension};
use ockam_identity::{SecureChannelOptions, Identifier};

async fn start_edge(
    license_key: &str,
    authority_identity: &Identifier,
    relay_address: &str,
) -> ockam::Result<()> {
    let node = node(Context::new()).await?;

    // Create edge identity
    let edge_identity = node.create_identity().await?;

    // Request credential from authority
    let credential = request_edge_credential(
        &edge_identity,
        license_key,
        authority_identity,
    ).await?;

    // Connect to relay (outbound TCP - works through NAT)
    let tcp = node.create_tcp_transport().await?;
    let relay_connection = tcp.connect(relay_address, TcpConnectionOptions::new()).await?;

    // Create secure channel to gateway through relay
    let secure_channel = node.create_secure_channel(
        &edge_identity,
        route![relay_connection, "forward_to_gateway", "secure_channel_listener"],
        SecureChannelOptions::new()
            .with_credential(credential)
            .with_trust_policy(TrustIdentifierPolicy::new(gateway_identity))
    ).await?;

    // Create inlet for local proxy
    // Local apps connect to 127.0.0.1:8151, traffic is encrypted to gateway
    tcp.create_inlet(
        "127.0.0.1:8151",
        route![secure_channel, "outlet_api"],
        TcpInletOptions::new()
    ).await?;

    info!("Edge proxy listening on 127.0.0.1:8151");
    info!("Secure channel established to gateway");

    Ok(())
}
```

### 5.3 Gateway Implementation

```rust
// nexus-gateway with Ockam integration
use ockam::{node, Context, TcpOutletOptions, TcpTransportExtension};
use ockam_identity::{
    SecureChannelListenerOptions,
    CredentialAccessControl,
    TrustMultiIdentifiersPolicy,
};

async fn start_gateway(
    gateway_identity: &Identifier,
    authority_identity: &Identifier,
    allowed_edges: Vec<Identifier>,
) -> ockam::Result<()> {
    let node = node(Context::new()).await?;
    let tcp = node.create_tcp_transport().await?;

    // Create secure channel listener
    node.create_secure_channel_listener(
        gateway_identity,
        "secure_channel_listener",
        SecureChannelListenerOptions::new()
            .with_trust_policy(TrustMultiIdentifiersPolicy::new(allowed_edges))
            .with_credential_verifier(authority_identity)
    ).await?;

    // Create outlets to backend services with access control
    let access_control = CredentialAccessControl::new(
        &[(b"role".to_vec(), b"edge".to_vec())],
        authority_identity,
    );

    tcp.create_outlet(
        "outlet_api",
        "127.0.0.1:8000",  // nexus-orchestrator
        TcpOutletOptions::new()
            .with_incoming_access_control(access_control.clone())
    ).await?;

    tcp.create_outlet(
        "outlet_inference",
        "127.0.0.1:8801",  // nexus-inference
        TcpOutletOptions::new()
            .with_incoming_access_control(access_control.clone())
    ).await?;

    tcp.create_outlet(
        "outlet_context",
        "127.0.0.1:8151",  // nexus-context
        TcpOutletOptions::new()
            .with_incoming_access_control(access_control)
    ).await?;

    info!("Gateway listening for secure channels");

    Ok(())
}
```

### 5.4 Access Control Policies

```rust
// Per-customer isolation
let customer_access_control = CredentialAccessControl::new(
    &[
        (b"customer_id".to_vec(), b"cust_001".to_vec()),
        (b"role".to_vec(), b"edge".to_vec()),
    ],
    authority_identity,
);

// Tier-based feature access
let professional_features = CredentialAccessControl::new(
    &[
        (b"tier".to_vec(), b"professional".to_vec()),
    ],
    authority_identity,
);

// Capability-based access
let mcp_access = CredentialAccessControl::new(
    &[
        (b"capabilities".to_vec(), b"mcp".to_vec()),
    ],
    authority_identity,
);
```

---

## 6. Deployment Model

### 6.1 Infrastructure Components

```yaml
# Credential Authority (highly secured, rarely accessed)
credential-authority:
  replicas: 3  # HA deployment
  security:
    - Hardware security module (HSM) for key storage
    - Air-gapped network (optional)
    - Multi-person access controls
  responsibilities:
    - Issue edge credentials
    - Issue gateway credentials
    - Maintain revocation list

# Ockam Relay (public-facing)
ockam-relay:
  replicas: 5  # Global distribution
  security:
    - No access to plaintext
    - DDoS protection
    - Rate limiting
  responsibilities:
    - Accept edge connections
    - Route encrypted messages
    - Handle NAT traversal

# Per-Customer Gateway
nexus-gateway-customer-a:
  replicas: 2  # HA per customer
  security:
    - Dedicated namespace
    - Network policies
    - Credential-based access control
  responsibilities:
    - Accept secure channels from edge
    - Verify edge credentials
    - Route to backend services
```

### 6.2 Network Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           NETWORK FLOW                                       │
│                                                                             │
│  Customer Site                 Internet              Nexus Datacenter       │
│                                                                             │
│  ┌──────────┐                                       ┌──────────────────┐   │
│  │  Edge    │ ─── TCP (outbound) ───────────────► │   Ockam Relay     │   │
│  │  :8151   │     Encrypted secure channel         │   :4000           │   │
│  └──────────┘                                       └────────┬─────────┘   │
│                                                              │             │
│  Firewall:                                                   │             │
│  - No inbound ports required                                 │             │
│  - Only outbound TCP to relay                                ▼             │
│                                                     ┌──────────────────┐   │
│                                                     │   Gateway        │   │
│                                                     │   :8443          │   │
│                                                     │                  │   │
│                                                     │   Verifies:      │   │
│                                                     │   - Identity     │   │
│                                                     │   - Credential   │   │
│                                                     │   - Attributes   │   │
│                                                     └────────┬─────────┘   │
│                                                              │             │
│                                                              ▼             │
│                                                     ┌──────────────────┐   │
│                                                     │   Backend        │   │
│                                                     │   Services       │   │
│                                                     └──────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Migration Path

### Phase 1: Parallel Deployment (Current + Ockam) -- COMPLETE

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 1: Hybrid Mode  [IMPLEMENTED 2026-02-05]                              │
│                                                                             │
│  Edge ─── Current TLS ─────────── Gateway (existing)                        │
│       │                                                                     │
│       └── Ockam Secure Channel ── Gateway (new) ── Backend                  │
│                                                                             │
│  COMPLETED:                                                                 │
│  - nexus-gateway: Ockam SDK 0.150, identity, listener, outlets, ABAC       │
│    33 tests passing, 20 MB release binary                                  │
│  - nexus-edge: Ockam SDK 0.150, identity, secure channel client, creds    │
│    15 tests passing, 4.7 MB release binary                                 │
│  - Both support hybrid mode (Ockam + TLS fallback)                         │
│  - Ockam Identifier format: I + 64 hex chars (32 bytes)                    │
│  - CLI flags: --ockam, --ockam-identity, --ockam-gateway-id                │
│                                                                             │
│  REMAINING FOR PHASE 1 DEPLOYMENT:                                          │
│  - Credential Authority service (nexus-authority)                           │
│  - Ockam Relay deployment                                                   │
│  - TCP inlet/outlet integration with full Ockam runtime                     │
│  - Integration testing with live services                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Phase 2: Ockam Primary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 2: Ockam Primary                                                      │
│                                                                             │
│  Edge ─── Ockam Secure Channel ─── Gateway ─── Backend                      │
│                                                                             │
│  - All new customers on Ockam                                               │
│  - Existing customers migrated                                              │
│  - TLS fallback for legacy support                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Phase 3: End-to-End Ockam

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 3: Full End-to-End                                                    │
│                                                                             │
│  Edge ═══ Ockam ═══ Gateway ═══ Ockam ═══ Backend                           │
│                                                                             │
│  - Gateway becomes routing-only (no decryption)                             │
│  - Backend services have Ockam identities                                   │
│  - True end-to-end encryption                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Comparison: Current vs Ockam Model

| Aspect | Current (TLS + Pinning) | Ockam Model |
|--------|------------------------|-------------|
| **Encryption Scope** | Point-to-point (edge ↔ gateway) | End-to-end (edge ↔ backend) |
| **Gateway Decryption** | Yes - sees plaintext | Optional - can be pass-through |
| **Mutual Authentication** | Certificate verification | Cryptographic identity + credentials |
| **Authorization** | License key validation | Attribute-based access control |
| **Customer Isolation** | Dedicated gateway instances | Cryptographic credential separation |
| **Key Management** | Certificate rotation | Identity-based, automatic rotation |
| **NAT Traversal** | Requires exposed ports | Outbound-only via relay |
| **Compromise Resilience** | Gateway compromise = data leak | Gateway compromise = encrypted data only |
| **Audit** | Gateway logs | Cryptographically verifiable |

---

## 9. Dependencies

### Rust Crates

```toml
[dependencies]
# Ockam core
ockam = "0.130"
ockam_node = "0.130"
ockam_identity = "0.130"
ockam_transport_tcp = "0.130"
ockam_vault = "0.130"

# Existing dependencies
tokio = { version = "1.0", features = ["full"] }
tracing = "0.1"
```

### Infrastructure

| Component | Requirement |
|-----------|-------------|
| Credential Authority | Dedicated secure infrastructure |
| Ockam Relay | Can use Ockam Orchestrator (SaaS) or self-hosted |
| Edge Binary | ~8MB additional (Ockam library) |
| Gateway Binary | ~8MB additional (Ockam library) |

---

## 10. Related Documentation

- [nexus-security.md](./nexus-security.md) - Current security architecture
- [tech-arch.md](./tech-arch.md) - Platform technical architecture
- [Ockam Documentation](https://docs.ockam.io/) - Official Ockam docs
- [Noise Protocol](http://noiseprotocol.org/) - Cryptographic handshake specification

---

*Last Updated: 2026-02-05*
